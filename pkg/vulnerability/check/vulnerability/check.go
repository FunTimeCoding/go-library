package vulnerability

import (
	"fmt"
	"github.com/davecgh/go-spew/spew"
	"github.com/funtimecoding/go-library/pkg/system/run"
	"github.com/funtimecoding/go-library/pkg/vulnerability/check/vulnerability/option"
	"os"
)

func Check(o *option.Vulnerability) {
	r := run.New()
	r.Panic = false

	if true {
		r.Start("govulncheck", "-format", "openvex", "./...")
		v := ParseVEX(r.OutputString)

		if o.Verbose {
			fmt.Printf("VEX: %+v\n", v)
		}

		statements := Collect(o, v)

		if len(statements) > 0 {
			fmt.Printf("Vulnerabilities found: %d\n", len(statements))

			os.Exit(1)
		}
	}

	if false {
		r.Start("govulncheck", "-format", "json", "./...")
		m := ParseJSON(r.OutputString)
		fmt.Printf("Message: %+v\n", m)
		spew.Dump(m)
	}
}
