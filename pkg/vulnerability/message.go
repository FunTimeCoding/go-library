package vulnerability

import (
	"github.com/funtimecoding/go-library/pkg/vulnerability/osv"
	"time"
)

// https://github.com/golang/vuln/blob/master/internal/govulncheck/govulncheck.go

type Message struct {
	Config   *Config    `json:"config,omitempty"`
	Progress *Progress  `json:"progress,omitempty"`
	SBOM     *SBOM      `json:"SBOM,omitempty"`
	OSV      *osv.Entry `json:"osv,omitempty"`
	Finding  *Finding   `json:"finding,omitempty"`
}

type Config struct {
	ProtocolVersion string     `json:"protocol_version"`
	ScannerName     string     `json:"scanner_name,omitempty"`
	ScannerVersion  string     `json:"scanner_version,omitempty"`
	DB              string     `json:"db,omitempty"`
	DBLastModified  *time.Time `json:"db_last_modified,omitempty"`
	GoVersion       string     `json:"go_version,omitempty"`
	ScanLevel       string     `json:"scan_level,omitempty"`
	ScanMode        string     `json:"scan_mode,omitempty"`
}

type SBOM struct {
	GoVersion string    `json:"go_version,omitempty"`
	Modules   []*Module `json:"modules,omitempty"`
	Roots     []string  `json:"roots,omitempty"`
}

type Module struct {
	Path    string `json:"path,omitempty"`
	Version string `json:"version,omitempty"`
}

type Progress struct {
	Timestamp *time.Time `json:"time,omitempty"`
	Message   string     `json:"message,omitempty"`
}

type Finding struct {
	OSV          string   `json:"osv,omitempty"`
	FixedVersion string   `json:"fixed_version,omitempty"`
	Trace        []*Frame `json:"trace,omitempty"`
}

type Frame struct {
	Module   string    `json:"module"`
	Version  string    `json:"version,omitempty"`
	Package  string    `json:"package,omitempty"`
	Function string    `json:"function,omitempty"`
	Receiver string    `json:"receiver,omitempty"`
	Position *Position `json:"position,omitempty"`
}

type Position struct {
	Filename string `json:"filename,omitempty"`
	Offset   int    `json:"offset"`
	Line     int    `json:"line"`
	Column   int    `json:"column"`
}
